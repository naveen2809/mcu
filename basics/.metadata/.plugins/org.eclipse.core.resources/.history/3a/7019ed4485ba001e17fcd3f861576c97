/*
 * temp_on_lcd_over_wireless_rx.c
 * Displaying the RH and Temperature data received over nRFL01 Wireless Link
 * Reference: dht11_sensor_driver.c and lcd_pcf8574_test.c
 *  Created on: 24-Dec-2023
 *      Author: naveen
 */

#include <stdint.h>
#include <stdio.h>
#include <string.h>
#include "stm32f4xx.h"
#include "gpio_driver.h"
#include "common_utils.h"
#include "external_interrupt_config.h"

#define TRUE	1
#define FALSE	0

#define USART2_IRQ_NUM	38

extern struct USART_Handle_t Test_USART;

static char * usart_tx_message;
static int usart_tx_count;
static uint8_t usart_tx_begin;

static void USART_SendData_Interrupt(struct USART_Handle_t *pUSART_Handle,char *pTxBuf, uint32_t Len, uint8_t usart_irq_num);
static void USART_Interrupt_Callback(void);

int main(void)
{
	char message[] = "Testing Interrupt Callback: Hello World!!!\r\n";

	//Configure the Timer
	configure_delay_timer();

	//Configure UART
	configure_uart();

	//Enable the UART Interrupt
	USART_SendData_Interrupt(&Test_USART,message,strlen(message),USART2_IRQ_NUM);

	while(1)
	{

	}

	return 0;
}

void USART2_IRQHandler(void)
{
	USART_Interrupt_Callback();

	return;
}

void USART_Interrupt_Callback(void)
{
	if(usart_tx_begin == TRUE)
	{
		USART_EnableTXEInterrupt(&Test_USART);
		usart_tx_begin = FALSE;
		return;
	}

	if(usart_tx_count < strlen(usart_tx_message))
	{
		Test_USART.pUSART->USART_DR = usart_tx_message[usart_tx_count];
		usart_tx_count++;
	}

	if(usart_tx_count == strlen(usart_tx_message))
	{
		USART_DisableTXEInterrupt(&Test_USART);
	}

	return;
}

void USART_SendData_Interrupt(struct USART_Handle_t *pUSART_Handle, char *pTxBuf, uint32_t Len, uint8_t usart_irq_num)
{
	usart_tx_message = (char *) malloc(Len);
	strcpy(usart_tx_message,pTxBuf);

	NVIC_EnableIRQ(usart_irq_num);
	usart_tx_count = 0;
	usart_tx_begin = TRUE;
	NVIC_IRQSetPending(usart_irq_num);

	return;
}

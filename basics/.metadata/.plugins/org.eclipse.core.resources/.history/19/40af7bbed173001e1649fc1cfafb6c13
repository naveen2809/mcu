#include <stdint.h>
#include <string.h>
#include <stdio.h>
#include "stm32f4xx.h"
#include "usart_driver.h"
#include "gpio_driver.h"

#define UART_TX_PIN			GPIO_PIN_2
#define UART_RX_PIN			GPIO_PIN_3
#define SLEEP_COUNT			500000

struct USART_Handle_t Test_USART;

void configure_uart(void);
void configure_button(void);
void UART_SendChar(uint8_t ch);
void delay(void);


void EXTI0_IRQHandler(void)
{
	uint32_t *pGPIOD_ODR = (uint32_t *) GPIOD_ODR_ADDR;
	uint32_t current_value;
	uint32_t *pEXTI_PR = (uint32_t *) EXTI_PR_ADDR;

	// Toggling the LED
	current_value = ((*pGPIOD_ODR >> GPIO_PIN_NUM_OUTPUT) & 0x1);
	current_value ^= 0x1;
	*pGPIOD_ODR &= ~(1 << GPIO_PIN_NUM_OUTPUT);
	*pGPIOD_ODR |= (current_value << GPIO_PIN_NUM_OUTPUT);

	delay(); // For de-bouncing the input button

	// Clearing the EXTI_PR Register
	*pEXTI_PR |= (1 << EXTI_INTERRUPT_PIN_NUM);
}

int main(void)
{
	uint32_t count = 0;
	configure_uart();
	configure_button();

	while(1)
	{
		printf("Printf() function redirected to UART: %ld!\r\n",count++);
		delay();
	}

	return 0;
}

void configure_uart(void)
{
	//GPIO Pin Configuration
	EnablePeriClk(GPIOA);
	GPIOSetMode(GPIOA,UART_TX_PIN,GPIO_MODE_ALTFN);
	GPIOSetMode(GPIOA,UART_RX_PIN,GPIO_MODE_ALTFN);
	GPIOSetAltFn(GPIOA,UART_TX_PIN,GPIO_ALTFN_7);
	GPIOSetAltFn(GPIOA,UART_RX_PIN,GPIO_ALTFN_7);
	GPIOSetOutputType(GPIOA,UART_TX_PIN,GPIO_OPTYPE_PP);
	GPIOSetOutputType(GPIOA,UART_RX_PIN,GPIO_OPTYPE_PP);
	GPIOSetOutputSpeed(GPIOA,UART_TX_PIN,GPIO_OPSPEED_HIGH);
	GPIOSetOutputSpeed(GPIOA,UART_RX_PIN,GPIO_OPSPEED_HIGH);
	GPIOSetPullUpDownConfig(GPIOA,UART_TX_PIN,GPIO_PULL_UP);
	GPIOSetPullUpDownConfig(GPIOA,UART_RX_PIN,GPIO_PULL_UP);

	//USART Configuration
	Test_USART.pUSART = (struct USART_RegDef_t *) USART2;
	Test_USART.USART_Config.USART_Mode = USART_MODE_TX_RX;
	Test_USART.USART_Config.USART_DataLength = USART_DATA_LEN_8_BITS;
	Test_USART.USART_Config.USART_StopBits = USART_STOP_BITS_1;
	Test_USART.USART_Config.USART_ParityControl = USART_PARITY_DISABLE;
	Test_USART.USART_Config.USART_BaudRate = USART_SB_RATE_9600;
	Test_USART.USART_Config.USART_HWFlowControl = USART_HW_FLOW_CNTRL_NONE;

	EnablePeriClk(USART2);
	USART_Init(&Test_USART);
	USART_PeripheralEnable(&Test_USART);
}

void configure_button(void)
{

}

void UART_SendChar(uint8_t ch)
{
	USART_SendData(&Test_USART, &ch, 1);
}

void delay(void)
{
	uint32_t j;
	for(j=0;j<SLEEP_COUNT;j++);
}

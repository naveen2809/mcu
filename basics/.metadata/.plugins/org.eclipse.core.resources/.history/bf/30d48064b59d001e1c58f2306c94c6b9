/*
 * nRF24L01_Tx.c
 *
 *  Created on: 18-Dec-2023
 *      Author: naveen
 */


#include <stdint.h>
#include "spi_driver.h"
#include "gpio_driver.h"
#include <string.h>

#define MAX_DATA 500
#define SLEEP_COUNT 10000

#define SPI_DEV			SPI2
#define SPI_PORT		GPIOB
#define SPI_PIN_MOSI	1
#define SPI_PIN_MISO	1
#define SPI_PIN_CLK		1
#define SPI_PIN_SS		1

void delay(void)
{
	uint32_t j;
	for(j=0;j<SLEEP_COUNT;j++);
}

void configure_spi(void);

int main(void)
{
	char send_data[] = "A small world after all"
			"";
	char recv_data[MAX_DATA];
	uint8_t data_len = 11;

	struct SPI_Config_t SPI_Dev_Config;

	SPI_Dev_Config.SPIDeviceMode = SPI_DEVICE_MODE_MASTER;
	SPI_Dev_Config.SPIClockPol = SPI_CLK_POL_0;
	SPI_Dev_Config.SPIClockPhase = SPI_CLK_PHA_LE;
	SPI_Dev_Config.SPIClockFreq = SPI_CLK_FREQ_DIV4;
	SPI_Dev_Config.SPIDataFrameFormat = SPI_DFF_8_BITS;
	SPI_Dev_Config.SPISoftwareSlaveManagement = SPI_SW_SLAVE_MGNT_DI;
	SPI_Dev_Config.SPISSIFlag = SPI_SSI_1;
	SPI_Dev_Config.SPISSOEFlag = SPI_SSOE_EN;

	EnablePeriClk(GPIOB);
	GPIOSetMode(GPIOB,GPIO_PIN_12,GPIO_MODE_ALTFN);
	GPIOSetMode(GPIOB,GPIO_PIN_13,GPIO_MODE_ALTFN);
	GPIOSetMode(GPIOB,GPIO_PIN_14,GPIO_MODE_ALTFN);
	GPIOSetMode(GPIOB,GPIO_PIN_15,GPIO_MODE_ALTFN);
	GPIOSetAltFn(GPIOB,GPIO_PIN_12,GPIO_ALTFN_5);
	GPIOSetAltFn(GPIOB,GPIO_PIN_13,GPIO_ALTFN_5);
	GPIOSetAltFn(GPIOB,GPIO_PIN_14,GPIO_ALTFN_5);
	GPIOSetAltFn(GPIOB,GPIO_PIN_15,GPIO_ALTFN_5);

	EnablePeriClk(SPI2);
	SPIPeriConfig(SPI2, &SPI_Dev_Config);
	SPIEnable(SPI2);

	SPISendData(SPI2,(uint8_t*)data_len,1);
	delay();
	SPISendData(SPI2,(uint8_t*)send_data,strlen(send_data));

	//SPIRecvData(SPI2,(uint8_t*)recv_data,strlen(recv_data));

	SPIDisable(SPI2);

	while(1);

	return 0;

}

void configure_spi(void)
{
	struct SPI_Config_t SPI_Dev_Config;

	SPI_Dev_Config.SPIDeviceMode = SPI_DEVICE_MODE_MASTER;
	SPI_Dev_Config.SPIClockPol = SPI_CLK_POL_0;
	SPI_Dev_Config.SPIClockPhase = SPI_CLK_PHA_LE;
	SPI_Dev_Config.SPIClockFreq = SPI_CLK_FREQ_DIV4;
	SPI_Dev_Config.SPIDataFrameFormat = SPI_DFF_8_BITS;
	SPI_Dev_Config.SPISoftwareSlaveManagement = SPI_SW_SLAVE_MGNT_DI;
	SPI_Dev_Config.SPISSIFlag = SPI_SSI_1;
	SPI_Dev_Config.SPISSOEFlag = SPI_SSOE_EN;

	EnablePeriClk(SPI_PORT);
	GPIOSetMode(SPI_PORT,SPI_PIN_MOSI,GPIO_MODE_ALTFN);
	GPIOSetMode(SPI_PORT,SPI_PIN_MISO,GPIO_MODE_ALTFN);
	GPIOSetMode(SPI_PORT,SPI_PIN_CLK,GPIO_MODE_ALTFN);
	GPIOSetMode(SPI_PORT,SPI_PIN_SS,GPIO_MODE_ALTFN);
	GPIOSetAltFn(SPI_PORT,SPI_PIN_MOSI,GPIO_ALTFN_5);
	GPIOSetAltFn(SPI_PORT,SPI_PIN_MISO,GPIO_ALTFN_5);
	GPIOSetAltFn(SPI_PORT,SPI_PIN_CLK,GPIO_ALTFN_5);
	GPIOSetAltFn(SPI_PORT,SPI_PIN_SS,GPIO_ALTFN_5);

	EnablePeriClk(SPI_DEV);
	SPIPeriConfig(SPI_DEV, &SPI_Dev_Config);
	SPIEnable(SPI_DEV);

}
